import{jsx as n,Fragment as j,jsxs as U}from"@dropins/tools/preact-jsx-runtime.js";import{classes as F,Slot as G}from"@dropins/tools/lib.js";import{memo as C,useCallback as R}from"@dropins/tools/preact-compat.js";import{Field as O,Picker as Y,Input as J,InputDate as k,Checkbox as Q,TextArea as Z,Skeleton as P,SkeletonRow as $,Card as B,InLineAlert as ee,Button as H}from"@dropins/tools/components.js";import"@dropins/tools/preact.js";import{useRef as te,useState as N,useEffect as S,useCallback as L,useMemo as re}from"@dropins/tools/preact-hooks.js";import{useText as X}from"@dropins/tools/i18n.js";import{i as ae,j as se,k as de,d as ne,u as oe,e as le}from"./updateCustomerAddress.js";const ze=({slots:e,addressesFormTitle:a,className:i,addressFormId:s,inputsDefaultValueSet:r,billingCheckBoxValue:o,shippingCheckBoxValue:c,showBillingCheckBox:d,showShippingCheckBox:b,isOpen:g,onSubmit:E,onCloseBtnClick:T,onSuccess:I,onError:t,onChange:l})=>n("div",{className:F(["dropin-address-form"]),children:n(Te,{slots:e,addressesFormTitle:a,className:i,addressFormId:s,inputsDefaultValueSet:r,shippingCheckBoxValue:c,billingCheckBoxValue:o,showShippingCheckBox:b,showBillingCheckBox:d,isOpen:g,onSubmit:E,onCloseBtnClick:T,onSuccess:I,onError:t,onChange:l})}),ue=e=>e.reduce((a,{code:i,required:s,defaultValue:r})=>(s&&(a[i]=r),a),{}),ie=({fieldsConfig:e,onSubmit:a,handleSetCountryCode:i,onChange:s})=>{const{requiredFieldError:r}=X({requiredFieldError:"Account.FormText.requiredFieldError"}),o=te(null),[c,d]=N({}),[b,g]=N({}),[E,T]=N({previousCountryCode:null,previousRegionCode:null,initialLoad:!0});S(()=>{var A;const f=c.country_code,u=e==null?void 0:e.find(h=>h.code==="region");if(E.initialLoad)T(h=>({...h,previousCountryCode:f,initialLoad:!1}));else if(E.previousCountryCode!==f){T(m=>({...m,previousCountryCode:f}));const h=!((A=u==null?void 0:u.options)!=null&&A.length)&&!(u!=null&&u.defaultValue)||E.previousRegionCode?"":(u==null?void 0:u.defaultValue)??"";d(m=>({...m,region:h})),i(f)}u!=null&&u.defaultValue&&E.previousCountryCode===f&&T(h=>({...h,previousRegionCode:u.defaultValue}))},[e,c,E.previousCountryCode,E.initialLoad,E.previousRegionCode,i,d]),S(()=>{if(!(e!=null&&e.length))return;const f=ue(e);d(f)},[e==null?void 0:e.length]);const I=L((f,u)=>{const A=e.find(h=>h.code===f);return A!=null&&A.required&&!u?r:""},[e,r]),t=L(f=>{const{name:u,value:A,type:h,checked:m}=f==null?void 0:f.target,y=h==="checkbox"?m:A;d(_=>({..._,[u]:y}))},[]),l=L(f=>{const u=f.currentTarget,A=f.target,h=new FormData(u),m=Object.fromEntries(h.entries()),y={[A.name]:m[A.name]&&String(m[A.name])};s==null||s(m,y,f)},[s]),p=L(f=>{const{name:u,value:A,type:h,checked:m}=f==null?void 0:f.target,y=h==="checkbox"?m:A;g(_=>({..._,[u]:I(u,y)}))},[I]),M=L(f=>{f.preventDefault();let u=!0,A={},h=null;for(const[m,y]of Object.entries(c)){const _=I(m,y);_&&(A[m]=_,u=!1,h||(h=m))}if(g(A),h&&o.current){const m=o.current.elements.namedItem(h);m==null||m.focus()}a==null||a(f,u)},[c,I,a]);return{formData:c,errors:b,formRef:o,handleInputChange:t,handleFormChange:l,handleBlur:p,handleSubmit:M}};var z=(e=>(e.BOOLEAN="BOOLEAN",e.DATE="DATE",e.DATETIME="DATETIME",e.DROPDOWN="DROPDOWN",e.FILE="FILE",e.GALLERY="GALLERY",e.HIDDEN="HIDDEN",e.IMAGE="IMAGE",e.MEDIA_IMAGE="MEDIA_IMAGE",e.MULTILINE="MULTILINE",e.MULTISELECT="MULTISELECT",e.PRICE="PRICE",e.SELECT="SELECT",e.TEXT="TEXT",e.TEXTAREA="TEXTAREA",e.UNDEFINED="UNDEFINED",e.VISUAL="VISUAL",e.WEIGHT="WEIGHT",e.EMPTY="",e))(z||{});const ce=C(({loading:e,values:a,fields:i=[],errors:s,className:r="",onChange:o,onBlur:c})=>{const d=`${r}__field`,b=R((t,l,p)=>n(O,{error:p,className:F([d,`${d}--${t.id}`,[`${d}--${t.id}-hidden`,t.isHidden],t.className]),"data-testid":`${r}--${t.id}`,disabled:e,children:n(Y,{name:t.id,floatingLabel:`${t.label} ${t.required?"*":""}`,placeholder:t.label,"aria-label":t.label,options:t.options,onBlur:c,handleSelect:o,value:l||t.defaultValue})},t.id),[r,e,d,c,o]),g=R((t,l,p)=>n(O,{error:p,className:F([d,`${d}--${t.id}`,[`${d}--${t.id}-hidden`,t.isHidden],t.className]),"data-testid":`${r}--${t.id}`,disabled:e,children:n(J,{type:"text",name:t.id,value:l??t.defaultValue,placeholder:t.label,floatingLabel:`${t.label} ${t.required?"*":""}`,onBlur:c,onChange:o})},t.id),[r,e,d,c,o]),E=R((t,l,p)=>n(O,{error:p,className:F([d,`${d}--${t.id}`,[`${d}--${t.id}-hidden`,t.isHidden],t.className]),"data-testid":`${r}--${t.id}`,disabled:e,children:n(k,{type:"text",name:t.id,value:l||t.defaultValue,placeholder:t.label,floatingLabel:`${t.label} ${t.required?"*":""}`,onBlur:c,onChange:o})},t.id),[r,e,d,c,o]),T=R((t,l,p)=>n(O,{error:p,className:F([d,`${d}--${t.id}`,[`${d}--${t.id}-hidden`,t.isHidden],t.className]),"data-testid":`${r}--${t.id}`,disabled:e,children:n(Q,{name:t.id,checked:l||t.defaultValue,placeholder:t.label,label:`${t.label} ${t.required?"*":""}`,onBlur:c,onChange:o})},t.id),[r,e,d,c,o]),I=R((t,l,p)=>n(O,{error:p,className:F([d,`${d}--${t.id}`,[`${d}--${t.id}-hidden`,t.isHidden],t.className]),"data-testid":`${r}--${t.id}`,disabled:e,children:n(Z,{type:"text",name:t.id,value:l??t.defaultValue,label:`${t.label} ${t.required?"*":""}`,onBlur:c,onChange:o})},t.id),[r,e,d,c,o]);return i.length?n(j,{children:i.map(t=>{const l=s==null?void 0:s[t.id],p=a==null?void 0:a[t.id];switch(t.fieldType){case z.TEXT:return t.options.length?b(t,p,l):g(t,p,l);case z.MULTILINE:return g(t,p,l);case z.SELECT:return b(t,p,l);case z.DATE:return E(t,p,l);case z.BOOLEAN:return T(t,p,l);case"TEXTAREA":return I(t,p,l);default:return null}})}):null}),pe=C(({slots:e,name:a,loading:i,children:s,className:r="defaultForm",fieldsConfig:o,onSubmit:c,handleSetCountryCode:d,onChange:b})=>{const{formData:g,errors:E,formRef:T,handleInputChange:I,handleFormChange:t,handleBlur:l,handleSubmit:p}=ie({fieldsConfig:o,onSubmit:c,handleSetCountryCode:d,onChange:b});return U("form",{className:F(["dropin-form",r]),onSubmit:p,onChange:t,name:a,ref:T,children:[n(ce,{className:r,loading:i,fields:o,onChange:I,onBlur:l,errors:E,values:g}),e!=null&&e.AddressFormInputs?n(G,{"data-testid":"addressFormInputs",name:"AddressFormInputs",slot:e.AddressFormInputs,context:{formActions:{handleChange:I}}}):null,s]})}),Ue=({testId:e,withCard:a=!0})=>{const i=U(P,{"data-testid":e||"skeletonLoader",children:[n($,{variant:"heading",size:"xlarge",fullWidth:!1,lines:1}),n($,{variant:"heading",size:"xlarge",fullWidth:!0,lines:1}),n($,{variant:"heading",size:"xlarge",fullWidth:!0,lines:1})]});return a?i:n(B,{variant:"secondary",className:F(["dropin-account-loaders","dropin-account-loaders--card-loader"]),children:i})},fe=()=>U(P,{"data-testid":"addressFormLoader",children:[n($,{variant:"heading",size:"medium"}),n($,{variant:"empty",size:"medium"}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large",fullWidth:!0}),n($,{size:"large",fullWidth:!0,lines:3}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large"}),n($,{size:"large",fullWidth:!0})]}),he=()=>{const[e,a]=N(""),[i,s]=N({});S(()=>{ae().then(o=>{s(c=>({...c,country_code:o}))})},[]),S(()=>{e&&se(e).then(o=>{s(c=>({...c,region:o}))})},[e]);const r=L(o=>{o&&a(o)},[]);return{countryRegionOptions:i,handleSetCountryCode:r}},K={entityType:"CUSTOMER_ADDRESS",isUnique:!1,options:[],multilineCount:0,validateRules:[],defaultValue:!1,fieldType:z.BOOLEAN,className:"",required:!1,orderNumber:90,isHidden:!1},me={...K,label:"Set as default shipping address",name:"default_shipping",id:"default_shipping",code:"default_shipping",customUpperCode:"defaultShipping"},Ae={...K,label:"Set as default billing address",name:"default_billing",id:"default_billing",code:"default_billing",customUpperCode:"defaultBilling"},ye=(e,a)=>{const i=a.map(s=>({...s}));return i.forEach(s=>{if(Object.prototype.hasOwnProperty.call(e,s.customUpperCode)){const r=e[s.customUpperCode];if(s.customUpperCode==="region"&&typeof r=="object"){const o=r!=null&&r.regionCode&&(r!=null&&r.regionId)?`${r.regionCode},${r.regionId}`:r.region;s.defaultValue=o}else s.defaultValue=r}}),i},W=e=>{if(!e)return null;const a=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(s=>{a.has(s.name)||a.set(s.name,"false"),s.checked&&a.set(s.name,"true")}),a&&typeof a.entries=="function"){const s=a.entries();if(s&&typeof s[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(s)))||{}}return{}},be=e=>{switch(e){case"on":case"true":case 1:case"1":return!0;case"0":case"off":case"false":case 0:return!1;default:return!1}},ge=e=>{const a=["region","city","company","country_code","country_id","default_billing","default_shipping","fax","firstname","lastname","middlename","postcode","prefix","street","suffix","telephone","vat_id","addressId"],i={},s=[];return Object.keys(e).forEach(r=>{a.includes(r)?i[r]=e[r]:s.push({attribute_code:r,value:e[r]})}),s.length>0&&(i.custom_attributesV2=s),i},w=e=>{const a=["street","street_1","street_2"],i=["on","off","true","false"],s=[],r={};for(const l in e){const p=e[l];i.includes(p)&&(r[l]=be(p)),a.includes(l)&&s.push(p)}const{street:o,street_2:c,street_1:d,region:b,...g}=e,[E,T]=b?b.split(","):[void 0,void 0],I=T&&E?{region_id:+T,region_code:E}:{region:E},t=ge({...g,...r,region:{...I},street:s});return de(t,"camelCase",{})},Ee=(e,a)=>a!=null&&a.length?e.code==="region"?{...e,required:!!(a!=null&&a.length),options:a}:{...e,options:a}:e,Ie=({addressFormId:e,billingCheckBoxValue:a,shippingCheckBoxValue:i,showShippingCheckBox:s,showBillingCheckBox:r,countryRegionOptions:o,inputsDefaultValueSet:c,onCloseBtnClick:d,onSuccess:b,onError:g})=>{const[E,T]=N(!1),[I,t]=N(e||""),[l,p]=N([]),[M,f]=N({text:"",type:"success"});S(()=>{ne(I?"customer_address_edit":"customer_register_address").then(y=>{p(y)})},[I]);const u=L(()=>{f({text:"",type:"success"}),d==null||d()},[d]),A=L(async(y,_)=>{if(!_)return null;T(!0);const V=W(y.target),q=w(V);await oe(q).then(()=>{var x;b==null||b(),d==null||d(),(x=y==null?void 0:y.target)==null||x.reset()}).catch(x=>{f(D=>({...D,text:x.message,type:"error"})),g==null||g(x)}).finally(()=>{t(""),T(!1)})},[d,g,b]),h=L(async(y,_)=>{if(!_)return null;T(!0);const V=W(y.target),q=w(V);await le(q).then(()=>{var x;b==null||b(),d==null||d(),(x=y==null?void 0:y.target)==null||x.reset()}).catch(x=>{f(D=>({...D,text:x.message,type:"error"})),g==null||g(x)}).finally(()=>{t(""),T(!1)})},[d,g,b]),m=re(()=>{if(!l.length)return[];const y={...me,defaultValue:i,isHidden:!s},_={...Ae,defaultValue:a,isHidden:!r},V=[...l,y,_];return ye(c||{},V).filter(D=>!(I&&(D.customUpperCode==="defaultShipping"||D.customUpperCode==="defaultBilling")&&D.defaultValue)).map(D=>{const v=o[D.code];return Ee(D,v)})},[l,s,i,r,a,c,o,I]);return{inLineAlert:M,addressId:I,submitLoading:E,normalizeFieldsConfig:m,handleUpdateAddress:A,handleCreateAddress:h,handleOnCloseForm:u}},Te=({slots:e,addressesFormTitle:a,className:i,addressFormId:s,inputsDefaultValueSet:r,showShippingCheckBox:o=!0,showBillingCheckBox:c=!0,shippingCheckBoxValue:d=!0,billingCheckBoxValue:b=!0,isOpen:g,onSubmit:E,onCloseBtnClick:T,onSuccess:I,onError:t,onChange:l})=>{const p=X({secondaryButton:"Account.AddressForm.formText.secondaryButton",primaryButton:"Account.AddressForm.formText.primaryButton"}),{countryRegionOptions:M,handleSetCountryCode:f}=he(),{inLineAlert:u,addressId:A,submitLoading:h,normalizeFieldsConfig:m,handleUpdateAddress:y,handleCreateAddress:_,handleOnCloseForm:V}=Ie({addressFormId:s,inputsDefaultValueSet:r,countryRegionOptions:M,shippingCheckBoxValue:d,billingCheckBoxValue:b,showShippingCheckBox:o,showBillingCheckBox:c,onSuccess:I,onError:t,onCloseBtnClick:T});return g?m!=null&&m.length?U("div",{className:F(["dropin-address-form-wrapper",i]),children:[n("div",{className:"dropin-address-form-wrapper--title","data-testid":"addressesFormTitle",children:a}),u.text?n(ee,{"data-testid":"inLineAlert",className:"dropin-address-form-wrapper--notification",type:u.type,variant:"secondary",heading:u.text,icon:u.icon}):null,U(pe,{slots:e,className:"dropin-address-form",name:"addressesForm",loading:h,fieldsConfig:m,onSubmit:E||(A?y:_),handleSetCountryCode:f,onChange:l,children:[A?n("input",{type:"hidden",name:"addressId",value:A,"data-testid":"hidden_test_id"}):null,n("div",{className:"dropin-field dropin-address-form-wrapper--buttons",children:e!=null&&e.AddressFormActions?n(G,{"data-testid":"addressFormActions",name:"AddressFormActions",slot:e.AddressFormActions,context:{handleUpdateAddress:y,handleCreateAddress:_,addressId:A}}):U(j,{children:[n(H,{type:"button",onClick:V,variant:"secondary",disabled:h,children:p.secondaryButton}),n(H,{disabled:h,children:p.primaryButton})]})})]})]}):n("div",{children:n(fe,{})}):null};export{ze as A,Ue as C};
