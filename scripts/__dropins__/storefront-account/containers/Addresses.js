import{jsx as s,jsxs as C,Fragment as Y}from"@dropins/tools/preact-jsx-runtime.js";import{classes as M}from"@dropins/tools/lib.js";import{C as G}from"../chunks/AddressFormWrapper2.js";import*as y from"@dropins/tools/preact-compat.js";import{useCallback as W,useMemo as Z}from"@dropins/tools/preact-compat.js";import{Card as U,Button as O,Tag as q,Icon as V,Modal as D,ProgressSpinner as ee,Header as se}from"@dropins/tools/components.js";import{useState as v,useCallback as g,useEffect as te}from"@dropins/tools/preact-hooks.js";import{Fragment as ne}from"@dropins/tools/preact.js";import{u as H,g as re}from"../chunks/updateCustomerAddress.js";import"@dropins/tools/event-bus.js";import{e as oe}from"../chunks/convertCase.js";import{g as de,r as ie}from"../chunks/removeCustomerAddress.js";import{S as le,c as ae,E as ce}from"../chunks/checkIsFunction.js";import{A as K}from"../chunks/AddressFormWrapper.js";import{useText as $}from"@dropins/tools/i18n.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-customer-address.js";const J=({keysSortOrder:r,addressData:e,loading:i,setAddressId:n,handleRenderModal:o,handleRenderForm:l})=>{const t=$({cardLabelShipping:"Account.Addresses.addressesCard.cardLabelShipping",cardLabelBilling:"Account.Addresses.addressesCard.cardLabelBilling",actionRemove:"Account.Addresses.addressesCard.actionRemove",actionEdit:"Account.Addresses.addressesCard.actionEdit"}),h=W(()=>{n==null||n(e==null?void 0:e.id),o==null||o()},[o,e==null?void 0:e.id,n]),m=W(()=>{n==null||n(e==null?void 0:e.id),l==null||l()},[l,e==null?void 0:e.id,n]),A=Z(()=>{if(!r)return[];const{region:d,...u}=e,c={...u,...d};return r.filter(({name:a})=>c[a]).map(a=>({name:a.name,orderNumber:a.orderNumber,value:c[a.name],label:a.label}))},[e,r]);return s(U,{variant:"secondary",className:"dropin-address-card","data-testid":"addressCard",children:i?s(G,{}):C(Y,{children:[C("div",{className:"dropin-address-card__action",children:[o?s(O,{variant:"tertiary",onClick:h,"data-testid":"removeButton",children:t.actionRemove}):null,l?s(O,{variant:"tertiary",onClick:m,className:"dropin-address-card__action--editbutton","data-testid":"editButton",children:t.actionEdit}):null]}),s("div",{className:"dropin-address-card__description",children:A.map((d,u)=>{const c=d.label?`${d.label}: ${d==null?void 0:d.value}`:d==null?void 0:d.value;return s("p",{"data-testid":`${d.name}_${u}`,children:c},u)})}),e!=null&&e.defaultShipping||e!=null&&e.defaultBilling?C("div",{className:"dropin-address-card__labels",children:[e!=null&&e.defaultShipping?s(q,{label:t.cardLabelShipping.toLocaleUpperCase()}):null,e!=null&&e.defaultBilling?s(q,{label:t.cardLabelBilling.toLocaleUpperCase()}):null]}):null]})})},ue=r=>y.createElement("svg",{id:"Icon_Add_Base","data-name":"Icon \\u2013 Add \\u2013 Base",xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",...r},y.createElement("g",{id:"Large"},y.createElement("rect",{id:"Placement_area","data-name":"Placement area",width:24,height:24,fill:"#fff",opacity:0}),y.createElement("g",{id:"Add_icon","data-name":"Add icon",transform:"translate(9.734 9.737)"},y.createElement("line",{vectorEffect:"non-scaling-stroke",id:"Line_579","data-name":"Line 579",y2:12.7,transform:"translate(2.216 -4.087)",fill:"none",stroke:"currentColor"}),y.createElement("line",{vectorEffect:"non-scaling-stroke",id:"Line_580","data-name":"Line 580",x2:12.7,transform:"translate(-4.079 2.263)",fill:"none",stroke:"currentColor"})))),pe=({viewAllAddressesText:r,addNewAddress:e,minifiedView:i,className:n,routeAddressesPage:o})=>{const l=$({viewAllAddressesButton:"Account.AddressActions.viewAllAddressesButton",addNewAddressButton:"Account.AddressActions.addNewAddressButton"});return C("button",{className:M(["dropin-actions-address",["dropin-actions-address--viewall",i],["dropin-actions-address--address",!i],n]),"data-testid":"showRouteFullAddress",onClick:o,children:[s("span",{className:"dropin-actions-address--title","data-testid":"addressActionsText",children:i&&!e?r||l.viewAllAddressesButton:l.addNewAddressButton}),s(V,{source:i&&!e?le:ue,size:"32"})]})},me=({keysSortOrder:r,addressData:e,open:i,submitLoading:n,onRemoveAddress:o,closeModal:l})=>{const t=$({title:"Account.AddressModal.title",description:"Account.AddressModal.description",actionCancel:"Account.AddressModal.actionCancel",actionSave:"Account.AddressModal.actionSave"});return i?C(D,{title:s("h3",{children:t.title}),className:"dropin-address-modal",size:"full","data-testid":"addressModal",showCloseButton:!0,onClose:l,children:[n?s("div",{className:"dropin-address-modal__spinner","data-testid":"progressSpinner",children:s(ee,{stroke:"4",size:"large"})}):null,s("p",{children:t.description}),s(J,{addressData:e,keysSortOrder:r}),C("div",{className:"dropin-address-modal__wrapper--buttons",children:[s(O,{type:"button",onClick:l,variant:"secondary",disabled:n,children:t.actionCancel}),s(O,{disabled:n,onClick:o,children:t.actionSave})]})]}):null},fe=async(r,e)=>{if(e.length===1){const t=e[0],m=Object.values(t.region).every(d=>!!d)?{}:{region:{...t.region,regionId:0}};return!!await H({addressId:Number(t==null?void 0:t.id),defaultShipping:!1,defaultBilling:!1,...m})}const i=e.filter(t=>t.id!==r&&(t.defaultBilling||t.defaultShipping)||t.id!==r),n=e[e.length-1],o=i[0]||((n==null?void 0:n.id)!==r?n:null);return!o||!o.id?!1:!!await H({addressId:+o.id,defaultShipping:!0,defaultBilling:!0})},Ae=["firstname","lastname","city","company","country_code","region","region_code","region_id","telephone","id","vat_id","postcode","street","street_2","default_shipping","default_billing"],ge=({minifiedView:r,routeAddressesPage:e,onSuccess:i})=>{const[n,o]=v(!1),[l,t]=v(!1),[h,m]=v(!1),[A,d]=v(!1),[u,c]=v(!1),[a,w]=v(""),[N,E]=v([]),[F,T]=v([]),f=g(async()=>{m(!0),Promise.all([re("shortRequest"),de()]).then(B=>{const[x,p]=B;if(x){const j=x.map(({name:L,orderNumber:Q,label:X})=>({name:oe(L),orderNumber:Q,label:Ae.includes(L)?null:X}));T(j)}if(p)if(r){const j=p.filter(L=>!!L.defaultShipping||!!L.defaultBilling);E(j)}else E(p)}).finally(()=>{m(!1)})},[r]);te(()=>{f()},[f]);const _=g(B=>{w(B),c(!1)},[]),b=g(()=>{t(!0)},[]),S=g(()=>{w(""),t(!1),o(!1)},[]),I=g(()=>{o(!0)},[]),z=g(async()=>{d(!0),await fe(a,N),ie(+a).then(()=>{f(),S()}).finally(()=>{d(!1)})},[N,a,S,f]),k=g(()=>{c(!1)},[]),R=g(()=>{ae(e)&&r&&!u?window.location.href=e():(c(!0),w(""))},[u,e,r]),P=g(async()=>{await f(),await(i==null?void 0:i())},[f,i]);return{keysSortOrder:F,submitLoading:A,isModalRendered:n,isFormRendered:l,loading:h,addNewAddress:u,addressesList:N,addressId:a,handleRenderForm:b,handleRenderModal:I,removeAddress:z,onCloseBtnClick:S,setEditingAddressId:_,closeNewAddressForm:k,redirectToAddressesRoute:R,handleOnSuccess:P}},he=({className:r,minifiedView:e,inputsDefaultValueSet:i,newAddressesFormTitle:n,editAddressesFormTitle:o,viewAllAddressesText:l,showShippingCheckBox:t=!0,showBillingCheckBox:h=!0,shippingCheckBoxValue:m=!0,billingCheckBoxValue:A=!0,routeAddressesPage:d,onSuccess:u,onError:c})=>{const a=$({newAddressesFormTitle:"Account.Addresses.newAddressesFormTitle",editAddressesFormTitle:"Account.Addresses.editAddressesFormTitle",settingsAddressTitle:"Account.ContainersTitle.settingsAddressTitle"}),{keysSortOrder:w,submitLoading:N,isModalRendered:E,isFormRendered:F,loading:T,addNewAddress:f,addressesList:_,addressId:b,handleRenderForm:S,handleRenderModal:I,removeAddress:z,onCloseBtnClick:k,handleOnSuccess:R,setEditingAddressId:P,closeNewAddressForm:B,redirectToAddressesRoute:x}=ge({minifiedView:e,routeAddressesPage:d,onSuccess:u});return C("div",{children:[s("div",{children:e?null:s(se,{title:a.settingsAddressTitle})}),C("div",{className:M(["dropin-addresses-wrapper",r]),"data-testid":"addressesIdWrapper",children:[s(me,{addressData:_.find(p=>p.id===b),keysSortOrder:w,submitLoading:N,open:E,closeModal:k,onRemoveAddress:z}),T?s(G,{testId:"addressSkeletonLoader",withCard:!1}):s(ce,{isEmpty:!_.length,typeList:"address"}),_.map(p=>s(ne,{children:b===p.id&&F?s(U,{variant:"secondary",style:{marginBottom:20},children:s(K,{isOpen:b===p.id&&F,addressFormId:b,inputsDefaultValueSet:p,addressesFormTitle:o||a.editAddressesFormTitle,showShippingCheckBox:t,showBillingCheckBox:h,shippingCheckBoxValue:m,billingCheckBoxValue:A,onCloseBtnClick:k,onSuccess:R,onError:c})}):s(J,{addressData:p,keysSortOrder:w,loading:T,setAddressId:P,handleRenderModal:I,handleRenderForm:S},p.id)},p.id)),s("div",{className:"dropin-addresses__footer",children:f?s("div",{className:M(["dropin-addresses-form__footer__wrapper",["dropin-addresses-form__footer__wrapper-show",f]]),children:s(U,{variant:"secondary",children:s(K,{isOpen:f,addressesFormTitle:n||a.newAddressesFormTitle,inputsDefaultValueSet:i,showShippingCheckBox:!!_.length,showBillingCheckBox:!!_.length,shippingCheckBoxValue:m,billingCheckBoxValue:A,onCloseBtnClick:B,onSuccess:R,onError:c})})}):s(pe,{minifiedView:e,addNewAddress:f,routeAddressesPage:x,viewAllAddressesText:l})})]})]})},Me=({className:r,minifiedView:e,inputsDefaultValueSet:i,newAddressesFormTitle:n,editAddressesFormTitle:o,viewAllAddressesText:l,showShippingCheckBox:t,showBillingCheckBox:h,shippingCheckBoxValue:m,billingCheckBoxValue:A,routeAddressesPage:d,onSuccess:u,onError:c})=>s("div",{className:M(["dropin-addresses",r]),"data-testid":"addressesid",children:s(he,{className:r,minifiedView:e,inputsDefaultValueSet:i,newAddressesFormTitle:n,editAddressesFormTitle:o,viewAllAddressesText:l,billingCheckBoxValue:A,shippingCheckBoxValue:m,showBillingCheckBox:h,showShippingCheckBox:t,routeAddressesPage:d,onSuccess:u,onError:c})});export{Me as Addresses,Me as default};
