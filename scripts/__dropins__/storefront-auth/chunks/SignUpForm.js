import{jsx as o,jsxs as E}from"@dropins/tools/preact-jsx-runtime.js";import{classes as at}from"@dropins/tools/lib.js";import{v as ot,u as nt,a as mt,P as ut}from"./usePasswordValidationMessage.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as lt,c as ct,a as ft}from"./createCustomerAddress.js";import{useState as b,useEffect as gt,useCallback as B}from"@dropins/tools/preact-hooks.js";import{s as Y,b as dt,c as ht}from"./simplifyTransformAttributesForm.js";import{p as Z,E as z,a as Ft}from"./getStoreConfig.js";import{c as K,g as bt,u as Ut,T as _t,F as yt,C as $,B as R}from"./useInLineAlert.js";import{InLineAlert as pt}from"@dropins/tools/components.js";import{S as Tt}from"./SkeletonLoader.js";import{E as Pt}from"./EmailConfirmationForm.js";import{useText as Lt}from"@dropins/tools/i18n.js";import{P as Et}from"./PasswordField.js";const D=(t,e)=>e!=null&&e.length?t.map(a=>{var s;const i=(s=e.find(({code:h})=>h===a.code))==null?void 0:s.defaultValue;return i?{...a,defaultValue:i}:a}):t,St=({inputsDefaultValueSet:t,fieldsConfigForApiVersion1:e,apiVersion2:a})=>{const[i,s]=b([]);return gt(()=>{(async()=>{var l;if(a){const r=await lt("customer_account_create");if((l=r==null?void 0:r.fields)!=null&&l.length)if(t!=null&&t.length){const c=D(r==null?void 0:r.fields,t);s(c)}else s(r==null?void 0:r.fields)}else{const r=Y(dt),c=Y(e),n=D(r,t);s(e&&e.length?c:n)}})()},[a,e,t]),{fieldsListConfigs:i}},xt=t=>{switch(t){case"true":return!0;case"false":return!1;default:return t}},Nt=(t,e)=>{if(!e)return t;const a={};a.custom_attributes=[];for(const i in t)Object.prototype.hasOwnProperty.call(ht,i)?a[i]=t[i]:a.custom_attributes.push({attribute_code:i,value:xt(t[i])});return a},Ct=({addressesData:t,translations:e,isEmailConfirmationRequired:a,apiVersion2:i=!0,passwordConfigs:s,routeRedirectOnSignIn:h,routeSignIn:l,onErrorCallback:r,onSuccessCallback:c,setActiveComponent:n,handleSetInLineAlertProps:f,routeRedirectOnEmailConfirmationClose:p})=>{const[I,S]=b(""),[x,m]=b(!1),[u,N]=b({userName:"",status:!1}),[C,g]=b(""),[w,k]=b(!1),[G,U]=b(!1),[M,v]=b(!0),T=B(({target:F})=>{v(F.checked)},[]),A=B(()=>{if(K(n)){n("signInForm");return}K(l)&&(window.location.href=l())},[n,l]),V=B(F=>{g(F)},[]),H=B(()=>{f({}),g(""),K(p)?window.location.href=p():(m(!1),n==null||n("signInForm"))},[f,p,n]);return{isKeepMeLogged:M,userEmail:I,showEmailConfirmationForm:x,isSuccessful:u,isClickSubmit:w,signUpPasswordValue:C,isLoading:G,onSubmitSignUp:async(F,O)=>{var Q;if(f({}),U(!0),!O){k(!0),U(!1);return}const q=i?"createCustomerV2":"createCustomer",_=bt(F.target),{email:P,password:L,is_subscribed:tt}=_,et=(s==null?void 0:s.requiredCharacterClasses)||0,rt=(s==null?void 0:s.minLength)||1;if(!ot(L,et)||rt>(L==null?void 0:L.length)){k(!0),U(!1);return}const st=Nt({..._,is_subscribed:!!tt||!1},i),{data:W,errors:y}=await ct(st,i);if(y&&(y!=null&&y.length))f==null||f({type:"error",text:y[0].message}),r==null||r(y),Z(z.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),S(P);else{const j={email:"",...W==null?void 0:W[q]};if(Z(z.CREATE_ACCOUNT_EVENT,{email:j==null?void 0:j.email,updateProfile:!0}),a){(Q=F.target)==null||Q.reset(),U(!1),g(""),m(!0),S(P);return}const d=await Ft({email:P,password:L,translations:e,handleSetInLineAlertProps:f,onErrorCallback:r});if(d!=null&&d.userName){if(t!=null&&t.length)for(const X of t)try{await ft(X)}catch(it){console.error(e.failedCreateCustomerAddress,X,it)}K(h)?window.location.href=h():(c==null||c({userName:d==null?void 0:d.userName,status:!0}),N({userName:d==null?void 0:d.userName,status:!0}))}}U(!1)},signInButton:A,handleSetSignUpPasswordValue:V,onKeepMeLoggedChange:T,handleHideEmailConfirmationForm:H}},$t=({addressesData:t,formSize:e="default",inputsDefaultValueSet:a,fieldsConfigForApiVersion1:i,apiVersion2:s=!0,displayTermsOfUseCheckbox:h=!1,displayNewsletterCheckbox:l=!1,hideCloseBtnOnEmailConfirmation:r=!1,routeRedirectOnEmailConfirmationClose:c,routeRedirectOnSignIn:n,routeSignIn:f,onErrorCallback:p,onSuccessCallback:I,setActiveComponent:S,successNotificationForm:x})=>{const m=Lt({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress"}),{passwordConfigs:u,isEmailConfirmationRequired:N}=nt(),{fieldsListConfigs:C}=St({fieldsConfigForApiVersion1:i,apiVersion2:s,inputsDefaultValueSet:a}),{inLineAlertProps:g,handleSetInLineAlertProps:w}=Ut(),{isKeepMeLogged:k,userEmail:G,showEmailConfirmationForm:U,isSuccessful:M,isClickSubmit:v,signUpPasswordValue:T,isLoading:A,onSubmitSignUp:V,signInButton:H,handleSetSignUpPasswordValue:J,onKeepMeLoggedChange:F,handleHideEmailConfirmationForm:O}=Ct({addressesData:t,translations:m,isEmailConfirmationRequired:N,apiVersion2:s,passwordConfigs:u,routeRedirectOnSignIn:n,routeSignIn:f,onErrorCallback:p,onSuccessCallback:I,setActiveComponent:S,handleSetInLineAlertProps:w,routeRedirectOnEmailConfirmationClose:c}),{isValidUniqueSymbols:q,defaultLengthMessage:_}=mt({password:T,isClickSubmit:v,passwordConfigs:u}),P=!N&&(t==null?void 0:t.length);return!C.length&&s?o("div",{className:`auth-signUpForm ${e} skeleton-loader`,"data-testid":"SignUpForm",children:o(Tt,{activeSkeleton:"signUpForm"})}):x&&M.status?x(M.userName):U?o(Pt,{formSize:e,userEmail:G,inLineAlertProps:g,hideCloseBtnOnEmailConfirmation:r,handleSetInLineAlertProps:w,onPrimaryButtonClick:O}):E("div",{className:at(["auth-signUpForm",e]),"data-testid":"SignUpForm",children:[o(_t,{text:m.title,bottomLine:!1,className:"auth-signUpForm__title"}),g.text?o(pt,{className:"auth-signUpForm__notification",type:g.type,variant:"secondary",heading:g.text,icon:g.icon}):null,E(yt,{submitCallback:V,className:"auth-signUpForm__form",isLoading:A,name:"signUp_form",fieldsConfig:C,children:[E(Et,{initialPassword:T,className:"auth-signUpForm__form__item",setPasswordValueCallback:J,isError:q==="error"||(_==null?void 0:_.status)==="error"||v&&T.length<=0,children:[o(ut,{minLength:u==null?void 0:u.minLength,requiredCharacterClasses:u==null?void 0:u.requiredCharacterClasses,validateLengthConfig:_,isValidUniqueSymbols:q}),P?o("div",{className:"auth-signUpForm__automatic-login",children:o($,{label:m.keepMeLoggedText,onChange:F,initialValue:k})}):null]}),l||h?E("div",{className:"auth-signUpForm__item auth-signUpForm__checkbox",children:[l?o($,{name:"is_subscribed",label:m.subscribedDefaultText}):null,h?o($,{name:"privacyPolicy",label:m.privacyPolicyDefaultText}):null]}):null,E("div",{className:"auth-signUpForm-buttons",children:[o(R,{type:"button",variant:"tertiary",style:{padding:0},buttonText:m.buttonSecondary,enableLoader:!1,onClick:H}),o(R,{type:"submit",buttonText:m.buttonPrimary,variant:"primary",enableLoader:A})]})]}),o("div",{id:"createCustomerV2"})]})};export{$t as S};
