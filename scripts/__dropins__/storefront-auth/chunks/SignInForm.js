import{jsxs as T,jsx as m}from"@dropins/tools/preact-jsx-runtime.js";import{classes as X}from"@dropins/tools/lib.js";import{g as Y,c as w,u as Z,T as $,F as z,B as G}from"./useInLineAlert.js";import{useState as _,useCallback as b,useEffect as q,useMemo as V}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as O}from"./getStoreConfig.js";import{r as R}from"./resendConfirmationEmail.js";import{s as tt,a as at}from"./simplifyTransformAttributesForm.js";import{c as rt}from"./confirmEmail.js";import{useText as H}from"@dropins/tools/i18n.js";import{InLineAlert as st}from"@dropins/tools/components.js";import{E as ot}from"./EmailConfirmationForm.js";import{P as et}from"./PasswordField.js";const it=({emailConfirmationStatusMessage:a,translations:r,initialEmailValue:e,routeSignUp:l,routeForgotPassword:u,routeRedirectOnSignIn:y,onErrorCallback:d,setActiveComponent:t,onSuccessCallback:c,onSignUpLinkClick:f,handleSetInLineAlertProps:s,routeRedirectOnEmailConfirmationClose:E})=>{const[A,N]=_(""),[g,I]=_(!1),[h,F]=_(""),[L,k]=_(!1),[B,p]=_({userName:"",status:!1}),[P,x]=_(!1),C=b(async i=>{await R(i),I(!0),s({})},[s]);q(()=>{a!=null&&a.text&&s({text:a.text,type:a.status?a.status:void 0})},[a,s]);const M=b(i=>r?T("span",{className:"auth-signInForm__resend-email-notification",children:[r.resendEmailInformationText," ",m("button",{onClick:()=>C(i),children:r.resendEmailButtonText})," ",r.resendEmailAdditionalText]}):"",[C,r]),U=b(async i=>{var K;s({}),x(!0);const n=Y(i.target);if(n.password||(k(!0),x(!1)),n!=null&&n.email&&(n!=null&&n.password)){const{email:D,password:Q}=n,o=await O({email:D,password:Q,handleSetInLineAlertProps:s,onErrorCallback:d,translations:r});if((K=o==null?void 0:o.errorMessage)!=null&&K.length){N(D);const W=o.errorMessage.includes("This account isn't confirmed. Verify and try again.")?M(D):o.errorMessage;s({text:W,type:"error"}),F("")}o!=null&&o.userName&&(i.target.reset(),w(y)?window.location.href=y():(c==null||c({userName:o==null?void 0:o.userName,status:!0}),p({userName:o==null?void 0:o.userName,status:!0}))),k(!1)}x(!1),F("")},[M,s,r,d,y,c]),v=b(()=>{if(w(t)){t("resetPasswordForm");return}w(u)&&(window.location.href=u())},[u,t]),S=b(()=>{if(w(f)&&f(),w(t)){t("signUpForm");return}w(l)&&(window.location.href=l())},[f,l,t]),j=V(()=>{const i=tt(at);return e!=null&&e.length?i==null?void 0:i.map(n=>({...n,defaultValue:e})):i},[e]),J=b(()=>{s({}),w(E)?window.location.href=E():I(!1)},[s,E]);return{userEmail:A,defaultEnhancedEmailFields:j,passwordError:L,isSuccessful:B,isLoading:P,signInPasswordValue:h,showEmailConfirmationForm:g,setShowEmailConfirmationForm:I,setSignInPasswordValue:F,submitLogInUser:U,forgotPasswordCallback:v,onSignUpLinkClickCallback:S,handledOnPrimaryButtonClick:J}},nt=()=>{let a=new URL(window.location.href),r=a.searchParams.get("email"),e=a.searchParams.get("key");r&&e&&(a.searchParams.delete("email"),a.searchParams.delete("key"),window.history.replaceState({},document.title,a.toString()))},mt=({enableEmailConfirmation:a})=>{const r=H({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[e,l]=_({text:"",status:""});return q(()=>{if(a){const{search:u}=window.location;u.includes("email=")&&u.includes("key=")&&(async()=>{var c,f,s;const d=new URLSearchParams(u),t=await rt({customerEmail:d.get("email"),customerConfirmationKey:d.get("key")});if(!t)return null;(c=t==null?void 0:t.errors)!=null&&c.length?l({text:t==null?void 0:t.errors[0].message,status:"error"}):(l({text:t.data.confirmEmail.customer.email?r.accountConfirmationEmailSuccessMessage.replace("{email}",(s=(f=t==null?void 0:t.data)==null?void 0:f.confirmEmail.customer)==null?void 0:s.email):r.accountConfirmMessage,status:"success"}),nt())})()}},[a,r]),{emailConfirmationStatusMessage:e}},xt=({formSize:a="default",initialEmailValue:r="",renderSignUpLink:e=!1,enableEmailConfirmation:l=!1,hideCloseBtnOnEmailConfirmation:u=!1,routeRedirectOnEmailConfirmationClose:y,routeRedirectOnSignIn:d,routeForgotPassword:t,routeSignUp:c,onSuccessCallback:f,setActiveComponent:s,onErrorCallback:E,onSignUpLinkClick:A,successNotificationForm:N})=>{const g=H({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",resendEmailAdditionalText:"Auth.Notification.resendEmailNotification.additionalText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage"}),{emailConfirmationStatusMessage:I}=mt({enableEmailConfirmation:l}),{inLineAlertProps:h,handleSetInLineAlertProps:F}=Z(),{userEmail:L,defaultEnhancedEmailFields:k,passwordError:B,isSuccessful:p,isLoading:P,signInPasswordValue:x,showEmailConfirmationForm:C,setSignInPasswordValue:M,submitLogInUser:U,forgotPasswordCallback:v,onSignUpLinkClickCallback:S,handledOnPrimaryButtonClick:j}=it({translations:g,emailConfirmationStatusMessage:I,initialEmailValue:r,routeSignUp:c,routeForgotPassword:t,routeRedirectOnSignIn:d,setActiveComponent:s,onErrorCallback:E,onSuccessCallback:f,onSignUpLinkClick:A,handleSetInLineAlertProps:F,routeRedirectOnEmailConfirmationClose:y});return N&&p.status?N(p.userName):C?m(ot,{formSize:a,userEmail:L,inLineAlertProps:h,hideCloseBtnOnEmailConfirmation:u,handleSetInLineAlertProps:F,onPrimaryButtonClick:j}):T("div",{className:X(["auth-signInForm",a]),"data-testid":"signInForm",children:[m($,{text:g.title,bottomLine:!1,className:"auth-signInForm__title"}),h.text?m(st,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:h.type,variant:"secondary",heading:h.text,icon:h.icon}):null,T(z,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:U,isLoading:P,fieldsConfig:k,children:[m(et,{className:"auth-signInForm__form__password",isError:B,initialPassword:x,setPasswordValueCallback:M}),T("div",{className:"auth-signInForm__form__buttons",children:[T("div",{className:"auth-signInForm__form__buttons--combine",children:[m(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:g.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:v,"data-testid":"switchToSignUp"}),e?m("span",{}):null,e?m(G,{type:"button",variant:"tertiary",style:{padding:0},buttonText:g.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:S}):null]}),m(G,{type:"submit",buttonText:g.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:P})]})]}),m("div",{id:"generateCustomerToken"})]})};export{xt as S};
