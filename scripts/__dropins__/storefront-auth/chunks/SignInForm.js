import{jsx as n,jsxs as P}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as $,classes as z}from"@dropins/tools/lib.js";import{g as O,c as y,u as R,T as tt,F as at,B as K}from"./useInLineAlert.js";import{useState as g,useCallback as x,useEffect as q,useMemo as st}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as et}from"./getCustomerToken.js";import{r as rt}from"./resendConfirmationEmail.js";import{s as ot,a as it}from"./simplifyTransformAttributesForm.js";import{c as nt}from"./confirmEmail.js";import{useText as Q}from"@dropins/tools/i18n.js";import{InLineAlert as ct,InputPassword as mt}from"@dropins/tools/components.js";import{E as ut}from"./EmailConfirmationForm.js";const lt=({emailConfirmationStatusMessage:t,translations:r,initialEmailValue:o,routeSignUp:c,routeForgotPassword:m,routeRedirectOnSignIn:F,onErrorCallback:b,setActiveComponent:a,onSuccessCallback:u,onSignUpLinkClick:h,handleSetInLineAlertProps:s,routeRedirectOnEmailConfirmationClose:_})=>{const[C,L]=g(""),[l,E]=g(!1),[f,N]=g(""),[S,w]=g(!1),[M,B]=g({userName:"",status:!1}),[p,I]=g(!1),[T,U]=g(!1),[v,k]=g([]),A=x(async d=>{await rt(d),s({text:"",type:"success"}),E(!0),w(!1),k([])},[s]);q(()=>{T&&(f.length?w(!1):w(!0))},[T,f]),q(()=>{t!=null&&t.text&&s({text:t.text,type:t.status?t.status:void 0})},[t,s]);const j=x(async d=>{var H;s({text:"",type:"success"}),I(!0),U(!0);const i=O(d.target);if(i.password||(w(!0),I(!1)),i!=null&&i.email&&(i!=null&&i.password)){const{email:G,password:Y}=i,e=await et({email:G,password:Y,handleSetInLineAlertProps:s,onErrorCallback:b,translations:r});if((H=e==null?void 0:e.errorMessage)!=null&&H.length){L(G);const J=e.errorMessage.includes("This account isn't confirmed. Verify and try again."),Z=J?r.resendEmailInformationText:e.errorMessage;J&&k([{label:r.resendEmailButtonText,onClick:()=>{A(G)}}]),s({text:Z,type:"error"}),N("")}e!=null&&e.userName&&(d.target.reset(),y(F)?window.location.href=F():(u==null||u({userName:e==null?void 0:e.userName,status:!0}),B({userName:e==null?void 0:e.userName,status:!0}))),w(!1)}I(!1)},[s,b,r,A,F,u]),D=x(()=>{if(y(a)){a("resetPasswordForm");return}y(m)&&(window.location.href=m())},[m,a]),V=x(()=>{if(y(h)&&h(),y(a)){a("signUpForm");return}y(c)&&(window.location.href=c())},[h,c,a]),W=st(()=>{const d=ot(it);return o!=null&&o.length?d==null?void 0:d.map(i=>({...i,defaultValue:o})):d},[o]),X=x(()=>{s({}),y(_)?window.location.href=_():E(!1)},[s,_]);return{additionalActionsAlert:v,userEmail:C,defaultEnhancedEmailFields:W,passwordError:S,isSuccessful:M,isLoading:p,signInPasswordValue:f,showEmailConfirmationForm:l,setShowEmailConfirmationForm:E,setSignInPasswordValue:N,submitLogInUser:j,forgotPasswordCallback:D,onSignUpLinkClickCallback:V,handledOnPrimaryButtonClick:X}},ft=()=>{let t=new URL(window.location.href),r=t.searchParams.get("email"),o=t.searchParams.get("key");r&&o&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},dt=({enableEmailConfirmation:t})=>{const r=Q({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[o,c]=g({text:"",status:""});return q(()=>{if(t){const{search:m}=window.location;m.includes("email=")&&m.includes("key=")&&(async()=>{var u,h,s;const b=new URLSearchParams(m),a=await nt({customerEmail:b.get("email"),customerConfirmationKey:b.get("key")});if(!a)return null;(u=a==null?void 0:a.errors)!=null&&u.length?c({text:a==null?void 0:a.errors[0].message,status:"error"}):(c({text:a.data.confirmEmail.customer.email?r.accountConfirmationEmailSuccessMessage.replace("{email}",(s=(h=a==null?void 0:a.data)==null?void 0:h.confirmEmail.customer)==null?void 0:s.email):r.accountConfirmMessage,status:"success"}),ft())})()}},[t,r]),{emailConfirmationStatusMessage:o}},kt=({slots:t,formSize:r="default",initialEmailValue:o="",renderSignUpLink:c=!1,enableEmailConfirmation:m=!1,hideCloseBtnOnEmailConfirmation:F=!1,routeRedirectOnEmailConfirmationClose:b,routeRedirectOnSignIn:a,routeForgotPassword:u,routeSignUp:h,onSuccessCallback:s,setActiveComponent:_,onErrorCallback:C,onSignUpLinkClick:L})=>{const l=Q({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{emailConfirmationStatusMessage:E}=dt({enableEmailConfirmation:m}),{inLineAlertProps:f,handleSetInLineAlertProps:N}=R(),{userEmail:S,additionalActionsAlert:w,defaultEnhancedEmailFields:M,passwordError:B,isSuccessful:p,isLoading:I,signInPasswordValue:T,showEmailConfirmationForm:U,setSignInPasswordValue:v,submitLogInUser:k,forgotPasswordCallback:A,onSignUpLinkClickCallback:j,handledOnPrimaryButtonClick:D}=lt({translations:l,emailConfirmationStatusMessage:E,initialEmailValue:o,routeSignUp:h,routeForgotPassword:u,routeRedirectOnSignIn:a,setActiveComponent:_,onErrorCallback:C,onSuccessCallback:s,onSignUpLinkClick:L,handleSetInLineAlertProps:N,routeRedirectOnEmailConfirmationClose:b});return p.status&&(t!=null&&t.SuccessNotification)?n($,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:p}}):U?n(ut,{formSize:r,userEmail:S,inLineAlertProps:f,hideCloseBtnOnEmailConfirmation:F,handleSetInLineAlertProps:N,onPrimaryButtonClick:D}):P("div",{className:z(["auth-signInForm",r]),"data-testid":"signInForm",children:[n(tt,{text:l.title,bottomLine:!1,className:"auth-signInForm__title"}),f.text?n(ct,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:f.type,variant:"secondary",heading:f.text,icon:f.icon,additionalActions:w}):null,P(at,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:k,isLoading:I,fieldsConfig:M,children:[n(mt,{hideStatusIndicator:!0,className:"auth-signInForm__form__password",autoComplete:"current-password",error:B,defaultValue:T,onValue:v,placeholder:l.placeholder,floatingLabel:l.floatingLabel}),P("div",{className:"auth-signInForm__form__buttons",children:[P("div",{className:"auth-signInForm__form__buttons--combine",children:[n(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:l.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:A,"data-testid":"switchToSignUp"}),c?n("span",{}):null,c?n(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:l.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:j}):null]}),n(K,{type:"submit",buttonText:l.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:I})]})]}),n("div",{id:"generateCustomerToken"})]})};export{kt as S};
