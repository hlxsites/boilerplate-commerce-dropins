import{jsx as o,Fragment as T,jsxs as B}from"@dropins/tools/preact-jsx-runtime.js";import{events as ne}from"@dropins/tools/event-bus.js";import{A as P,y as N,n as oe,V as _,l as Fe,z as Ie,q as Ee,m as Ae}from"./fixtures.js";import{b as Q,a as p,A as L,e as Ce,D as G,g as ke,M as ee,c as te}from"./getMultilineValues.js";import{useState as H,useCallback as O,useEffect as x,useRef as Se,useMemo as be}from"@dropins/tools/preact-hooks.js";import{classes as V,getFormErrors as we,VComponent as y}from"@dropins/tools/lib.js";import{Text as ae,useText as Me}from"@dropins/tools/i18n.js";import{Field as Z,Input as se,Picker as Re,Skeleton as $e,SkeletonRow as b,Divider as ye,ProgressSpinner as Le}from"@dropins/tools/components.js";/* empty css                     */import{forwardRef as Ne,useRef as _e,useImperativeHandle as De,useState as j,useEffect as X}from"@dropins/tools/preact-compat.js";import{E as xe}from"./ErrorBanner.js";import{M as ze}from"./MergedCartBanner.js";const J={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function ie(e){return Object.keys(e).length===0&&e.constructor===Object}const Pe=e=>e.map(t=>{var n;const r=((n=t==null?void 0:t.id)==null?void 0:n.toString())||t.code;return{text:t.name,value:r}}),Be=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function Oe({address:e,addressType:t,availableCountries:r,availableRegions:n,config:a,dismissError:s,errors:i,fields:u,onBlur:d,onChange:v,onInvalid:c,onSelection:h,setAddress:F}){const I=()=>{F(l=>({...l,[p.Region]:"",[p.RegionId]:""})),s(p.Region)},A=l=>{F(w=>({...w,[p.RegionId]:l}))};return u.map(l=>{var f;let w,g=l.frontendInput,S=h,M=v,R=l.isDisabled,D=l.isRequired,$=[],k;return g===P.Multiline?(k=Q(l.code,e),w=Q(l.code,i)):(k=e[l.code],w=i[l.code]||""),l.code===p.Country&&($=Be(r),t===L.SHIPPING&&(N.value.country=k,S=m=>{const E=m.target,{value:C}=E;C&&W({country_code:C}),h(m),I()})),l.code===p.RegionId&&t===L.SHIPPING&&(N.value.selectedRegionId=k),l.code===p.Region&&(t===N.value.addressType&&(R=N.value.pending),D=a.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),$=Pe(n),!D&&!a.displayStateIfOptional&&(g=P.Undefined),g=$.length>0?P.Select:P.Text,g===P.Select?t===L.SHIPPING?(N.value.selectedRegion=k,S=m=>{const C=m.target.value;W({country_code:N.value.country,region_id:C}),h(m),A(C)}):S=m=>{h(m);const C=m.target.value;A(C)}:g===P.Text&&t===L.SHIPPING&&(N.value.selectedRegion=k,M=m=>{const E=m.target,{value:C}=E;N.value.country&&W({country_code:N.value.country,region_name:C}),v(m)}),k=$.length>0?((f=$.find(m=>m.value===k))==null?void 0:f.value)||"":k),l.code===p.PostCode&&(D=!a.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...l,error:w,frontendInput:g,handleSelect:S,isDisabled:R,isRequired:D,onBlur:d,onChange:M,onInvalid:c,options:$,value:k}})}let re;function W(e){var s;const t=oe.value.data,r=!!t,n=(s=t==null?void 0:t.shippingAddresses)==null?void 0:s[0],a=n==null?void 0:n.availableShippingMethods;r&&!a&&(clearTimeout(re),re=setTimeout(()=>{Ce({criteria:e})},G))}const U=({addressType:e,code:t,index:r})=>r?`${e}-${t}-${r}`:`${e}-${t}`,q=e=>`checkout-address-form__${e}`,Ve=({addressType:e,element:t})=>{const{code:r,value:n,defaultValue:a}=t;return o("input",{className:q(r),id:U({addressType:e,code:r}),name:r,type:"hidden",value:n||a},r)},Te=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:a,label:s,onBlur:i,onChange:u,onInvalid:d,validateRules:v,value:c}=t,h=ce(v);return o(Z,{disabled:a,error:n,children:o(se,{"aria-label":s,autocomplete:J[r]||"off",className:q(r),floatingLabel:`${s} ${t.isRequired?"*":""}`,id:U({addressType:e,code:r}),onBlur:i,onChange:u,onInvalid:d,placeholder:s,required:t.isRequired||!1,type:"text",name:r,value:c??void 0,...h})})},Ge=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:a,isRequired:s,label:i,multilineCount:u,onBlur:d,onChange:v,onInvalid:c,validateRules:h,value:F}=t,I=u??0,A=ce(h);return o(T,{children:Array.from(Array(I).keys()).map(l=>o(Z,{disabled:a,error:(n==null?void 0:n[l])||"",className:"dropin-field--multiline",children:o(se,{id:U({addressType:e,code:r,index:l}),className:q(r),floatingLabel:`${i} ${l!=0?l:""} ${s&&l===0?"*":""}`,autocomplete:l===0?J[r]:"off","aria-label":i,placeholder:`${i} ${l!=0?l:""}`,type:"text",required:s&&l===0,onChange:v,onBlur:d,onInvalid:c,name:`${r}-${l}`,value:(F==null?void 0:F[l])||void 0,...A})},`${r}-${l}`))})},He=({addressType:e,element:t})=>{const{code:r,error:n,handleSelect:a,isDisabled:s,isRequired:i,label:u,onBlur:d,onInvalid:v,options:c,value:h}=t,F=a?{handleSelect:a}:{};return o(Z,{disabled:s,error:n,children:o(Re,{id:U({addressType:e,code:r}),className:q(r),name:r,floatingLabel:`${u} ${i?"*":""}`,required:i,placeholder:u,"aria-label":u,options:c,value:h,autocomplete:J[r]||"off",onBlur:d,onInvalid:v,...F},r)})},Ue=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return Ve({addressType:e,element:t});case"TEXT":return Te({addressType:e,element:t});case"MULTILINE":return Ge({addressType:e,element:t});case"SELECT":return He({addressType:e,element:t});default:return null}},ce=e=>e?e.reduce((t,r)=>{switch(r.name){case _.DateRangeMax:return{...t,max:r.value};case _.DateRangeMin:return{...t,min:r.value};case _.FileExtensions:return{...t,accept:r.value};case _.InputValidation:return{...t,pattern:qe(r.value)};case _.MaxFileSize:case _.MaxImageHeight:case _.MaxImageWidth:return t;case _.MaxTextLength:return{...t,maxLength:r.value};case _.MinTextLength:return{...t,minLength:r.value};default:throw new Error(`Unknown rule: ${r.name}`)}},{}):{},z={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},qe=e=>{switch(e){case"alpha":return z.alpha.source;case"alphanumeric":return z.alphanumeric.source;case"alphanumeric-w-space":return z["alphanumeric-w-space"].source;case"alphanum-with-spaces":return z["alphanum-with-spaces"].source;case"url":return z.url.source;case"numeric":return z.numeric.source;case"email":return z.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},We=e=>B($e,{...e,children:[o(b,{variant:"heading",size:"medium"}),o(b,{variant:"empty",size:"medium"}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large",fullWidth:!0}),o(b,{size:"large",fullWidth:!0,lines:3}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large"}),o(b,{size:"large"})]}),Ze=({addressType:e,className:t,fields:r,formRef:n,headingId:a,name:s,...i})=>B("div",{...i,className:V(["checkout-fields-form",t]),children:[o(me,{level:2,children:o(ae,{id:a}),className:"checkout-fields-form__title"}),o("form",{name:s,ref:n,className:V(["checkout-fields-form__form",t]),noValidate:!0,children:r.sort((u,d)=>!u.sortOrder||!d.sortOrder?u.code<d.code?-1:1:u.sortOrder-d.sortOrder).map(u=>Ue({element:u,addressType:e}))})]}),je=e=>{const t=new FormData(e),r=Object.fromEntries(t);return Object.entries(r).reduce((a,[s])=>{const i=e.elements[s];return i!=null&&i.validationMessage?{...a,[s]:i.validationMessage}:{...a}},{})};function Xe(e){const[t,r]=j({});return X(()=>{e&&r(n=>({...n,country_id:e}))},[e]),{defaultValues:t}}function Je({country:e,addressType:t}){const[r,n]=j([]);return X(()=>{if(!e){n([]);return}ke(e,t).then(a=>{n(a||[])}).catch(a=>{console.error(a)})},[n,e,t]),{availableRegions:r}}function Ke({autoFill:e,addressType:t,dismissError:r,loadAutoFill:n}){const[a,s]=j(!1),i=Ae.value.data,u=!!i,d=oe.value.data,v=!!d;X(()=>{var w;if(!e||!v||a)return;let c,h=!1;c=gt({addressType:t,cart:d}),!c&&u&&(c=mt({addressType:t,customer:i}),h=!0);const F=g=>g?g.split(te).length>1:!1;if(!c)return;s(!0);const I={[p.City]:c.city,[p.Company]:c.company||"",[p.Country]:c.country.value,[p.FirstName]:c.firstName,[p.LastName]:c.lastName,[p.PostCode]:c.postCode||"",[p.Telephone]:c.telephone||"",[p.Vat]:c.vatId||""},A=c.region;if(A){const g=(w=A==null?void 0:A.id)==null?void 0:w.toString();g?(I[p.Region]=g,I[p.RegionId]=g):I[p.Region]=A.code}c!=null&&c.street&&c.street.length>0&&c.street.forEach((g,S)=>{I[`${p.Street}${ee}${S}`]=g}),((c==null?void 0:c.customAttributes)||[]).forEach(g=>{F(g.code)?g.value.split(te).forEach((M,R)=>{I[`${g.code}${ee}${R}`]=M}):I[g.code]=g.value}),n({values:I,triggerAutoSave:h})},[t,e,d,i,a,v,u,n,r])}const Nt=Ne(({addressType:e,autoFill:t=!0,children:r,headingId:n,name:a,preselectedFields:s,saveAddressHandler:i,onCheckoutDataUpdate:u,...d},v)=>{const{data:c,pending:h}=Fe.value,F=Ie.value.data,I=F===void 0,A=c===void 0||h,l=Ee.value.data,w=l===void 0,{defaultValues:g}=Xe(l==null?void 0:l.defaultCountry),S=dt({fields:c,preselectedFields:s}),M=_e(null),{address:R,errors:D,loadAutoFill:$,onBlur:k,dismissError:f,onChange:m,onInvalid:E,onSelection:C,setAddress:ge}=lt({defaultValues:g,formRef:M,onCheckoutDataUpdate:u,preselection:S,saveAddressHandler:i,type:e}),{availableRegions:fe}=Je({country:R.country_id,addressType:e});if(De(v,()=>({triggerSaveAddress:pe=>{if(!M.current)return;const ve=je(M.current);if(ie(ve))return i({signal:pe,address:R})}})),Ke({addressType:e,autoFill:t,loadAutoFill:$,dismissError:f}),A||I||w)return o(We,{"data-testid":`${e}-skeleton`});const he=Oe({address:R,addressType:e,availableCountries:F,availableRegions:fe,config:l,dismissError:f,errors:D,fields:c,onBlur:k,onChange:m,onInvalid:E,onSelection:C,setAddress:ge}),Y={[L.SHIPPING]:"shipping",[L.BILLING]:"billing"};return o(Ze,{...d,name:a,addressType:e,className:`checkout-${Y[e]}-form`,"data-testid":`${Y[e]}-form`,fields:he,formRef:M,headingId:n})}),Ye="DROPIN__CHECKOUT",K=e=>`${Ye}__${e.toUpperCase()}`,Qe=(e,t)=>{window.localStorage.setItem(K(e),JSON.stringify(t))},et=e=>{const t=window.localStorage.getItem(K(e));return t?JSON.parse(t):null},tt=e=>{window.localStorage.removeItem(K(e))};function rt(e){const[t,r]=H(null),n=O(s=>setTimeout(()=>{Qe(e,s)},G),[e]),a=O(()=>{tt(e)},[e]);return x(()=>{const s=et(e);s&&r(s)},[e]),x(()=>{const s=ne.on("checkout/order",()=>{a()});return()=>{s==null||s.off()}},[a]),{addressBackup:t,backupAddress:n,removeAddressBackup:a}}const nt={[L.BILLING]:"billing",[L.SHIPPING]:"shipping"};function ot({address:e,type:t}){x(()=>{const r=setTimeout(()=>{ne.emit("checkout/address",{type:nt[t],address:e})},G);return()=>{clearTimeout(r)}},[e,t])}const at={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},st=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],it=e=>{const[t,r]=H({}),n=O(i=>{const{name:u,validity:d,validationMessage:v}=i;let c=d.valid?"":v;st.forEach(h=>{if(!d[h])return;const F=e[h];if(!F)return;const I=at[h];c=F.replace("{field}",i.getAttribute(I)||"")}),r(h=>({...h,[u]:c}))},[e]);return{errors:t,dismissError:i=>{t[i]&&r(u=>{const{[i]:d,...v}=u;return v})},validateFormElement:n,resetErrors:()=>{r({})}}},ct=e=>{const t=e.current;if(!t)return!1;const r=we(t);return ie(r)},lt=({defaultValues:e={},formRef:t,onCheckoutDataUpdate:r,preselection:n={},saveAddressHandler:a,type:s})=>{const i=Me({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),u=Se(!1),[d,v]=H({});ot({address:d,type:s});const{addressBackup:c,backupAddress:h,removeAddressBackup:F}=rt(s),{errors:I,validateFormElement:A,dismissError:l,resetErrors:w}=it(i),g=O(f=>{u.current=!1,a(f).then(()=>{F(),r==null||r()}).catch(m=>{u.current=!0,console.error("Saving address form failed:",m)})},[F,a,r]),S=(f,m)=>{v(E=>({...E,[f]:m})),u.current=!0},M=({values:f,triggerAutoSave:m=!1})=>{w(),v(E=>({...E,...f})),m&&(u.current=!0)},R=f=>{const m=f.target,{name:E,value:C}=m;S(E,C),A(m)},D=f=>{const m=f.target;A(m)},$=f=>{const m=f.target,{name:E,value:C}=m;S(E,C),A(m)},k=f=>{f.target.checkValidity()};return x(()=>{v(f=>({...e,...n,...c,...f}))},[e,n,c]),x(()=>{if(!u.current)return;const f=h(d);return()=>{clearTimeout(f)}},[d,h]),x(()=>{if(!u.current||!ct(t))return;const f=new AbortController,m=f.signal,E=setTimeout(()=>{g({signal:m,address:d})},G);return()=>{clearTimeout(E),f.abort()}},[d,t,g]),{address:d,errors:I,loadAutoFill:M,dismissError:l,onChange:R,onSelection:$,onBlur:k,onInvalid:D,setAddress:v}},ut={countryCode:p.Country,region:p.Region,postCode:p.PostCode};function dt({fields:e,preselectedFields:t}){return be(()=>!(!!e&&e.length>0)||!!!t?{}:Object.keys(t).reduce((a,s)=>{const i=ut[s];return!i||!e.some(d=>d.code===i)?a:{...a,[i]:t[s]}},{}),[e,t])}const mt=({addressType:e,customer:t})=>e===L.BILLING?t.defaultBillingAddress:t.defaultShippingAddress,gt=({addressType:e,cart:t})=>{if(e===L.BILLING)return t.billingAddress;const r=t.shippingAddresses;if(!(!r||r.length===0))return r[0]},le=()=>{const e=()=>window.innerWidth>=1920?"xxlarge":window.innerWidth>=1366?"xlarge":window.innerWidth>=1024?"large":window.innerWidth>=768?"medium":"small",[t,r]=H(e());return x(()=>{let n;const a=()=>{n&&clearTimeout(n),n=setTimeout(()=>r(e()),50)};return window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a),n&&clearTimeout(n)}},[]),t},ft=()=>{const e=O(()=>{document.body.style.overflow="hidden"},[]),t=O(()=>{document.body.style.overflow=""},[]);return{lockScroll:e,unlockScroll:t}},ue=({children:e,className:t})=>le()==="small"?o(T,{children:e}):o("div",{className:t,children:e}),ht=({sections:e})=>o(ue,{className:"checkout__aside",children:e.orderSummary&&o(y,{node:e.orderSummary})}),pt=({billingAddress:e,billToShippingAddress:t,login:r,outOfStock:n,paymentMethods:a,placeOrder:s,shippingAddress:i,shippingMethods:u})=>{const d=le();return B(T,{children:[o(y,{node:n}),o(y,{node:r}),i&&o(y,{node:i}),t&&o(y,{node:t}),u&&o(y,{node:u}),o(y,{node:a}),o(y,{node:e}),o(y,{node:s}),d==="small"&&o(y,{node:n})]})},vt=({sections:e})=>o(ue,{className:"checkout__main",children:B(T,{children:[B("div",{className:"checkout-heading",children:[o(me,{level:1,className:"checkout-heading__title",children:o(ae,{id:"Checkout.title"})}),o(ye,{variant:"primary",className:"checkout-heading__divider-primary"})]}),e&&o(pt,{...e})]})}),de=({children:e,className:t,isLoading:r=!1,...n})=>B("div",{"data-testid":"checkout",className:V(["checkout",t]),...n,children:[r&&o(Ft,{}),o(xe,{}),o(ze,{}),o("div",{className:"checkout__content",children:e})]});de.Main=vt;de.Aside=ht;const me=({className:e,children:t,level:r=2})=>{const n=r>=1&&r<=6?`h${r}`:"h2";return o(n,{className:e,children:t})},Ft=({className:e})=>{const{lockScroll:t,unlockScroll:r}=ft();return x(()=>(t(),r),[t,r]),o("div",{"data-testid":"checkout-overlay-loader",className:V(["checkout-overlay-loader",e]),children:o(Le,{})})};export{Nt as A,de as C,me as H,z as p};
