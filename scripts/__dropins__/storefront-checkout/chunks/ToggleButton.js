import{events as re}from"@dropins/tools/event-bus.js";import{A as P,z as L,n as ne,V as w,B as ge,q as fe,m as he}from"./fixtures.js";import{b as Y,a as F,A as R,e as pe,D as U,g as Fe,M as Q,c as ee}from"./getMultilineValues.js";import{useState as q,useCallback as O,useEffect as z,useRef as ve,useMemo as Ie}from"@dropins/tools/preact-hooks.js";import{classes as V,getFormErrors as Ee,VComponent as _}from"@dropins/tools/lib.js";import{Text as oe,useText as Ae}from"@dropins/tools/i18n.js";import{Field as Z,Input as ae,Picker as Ce,Skeleton as Se,SkeletonRow as k,ProgressSpinner as ke}from"@dropins/tools/components.js";/* empty css                     */import{jsx as s,Fragment as se,jsxs as B}from"@dropins/tools/preact-jsx-runtime.js";import{forwardRef as be,useRef as Me,useImperativeHandle as $e,useState as j,useEffect as W}from"@dropins/tools/preact-compat.js";import{u as Re}from"./address-form-fields.js";import{E as Le}from"./ErrorBanner.js";import{M as we}from"./MergedCartBanner.js";const X={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function ie(e){return Object.keys(e).length===0&&e.constructor===Object}const ye=e=>e.map(t=>{var n;const r=((n=t==null?void 0:t.id)==null?void 0:n.toString())||t.code;return{text:t.name,value:r}}),Ne=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function De({address:e,addressType:t,availableCountries:r,availableRegions:n,config:a,dismissError:i,errors:o,fields:d,onBlur:g,onChange:v,onInvalid:c,onSelection:h,setAddress:E}){const p=()=>{E(l=>({...l,[F.Region]:"",[F.RegionId]:""})),i(F.Region)},A=l=>{E(S=>({...S,[F.RegionId]:l}))};return d.map(l=>{var I;let S,m=l.frontendInput,C=h,y=v,N=l.isDisabled,D=l.isRequired,b=[],u;return m===P.Multiline?(u=Y(l.code,e),S=Y(l.code,o)):(u=e[l.code],S=o[l.code]||""),l.code===F.Country&&(b=Ne(r),t===R.SHIPPING&&(L.value.country=u,C=f=>{const M=f.target,{value:$}=M;$&&H({country_code:$}),h(f),p()})),l.code===F.RegionId&&t===R.SHIPPING&&(L.value.selectedRegionId=u),l.code===F.Region&&(t===L.value.addressType&&(N=L.value.pending),D=a.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),b=ye(n),!D&&!a.displayStateIfOptional&&(m=P.Undefined),m=b.length>0?P.Select:P.Text,m===P.Select?t===R.SHIPPING?(L.value.selectedRegion=u,C=f=>{const $=f.target.value;H({country_code:L.value.country,region_id:$}),h(f),A($)}):C=f=>{h(f);const $=f.target.value;A($)}:m===P.Text&&t===R.SHIPPING&&(L.value.selectedRegion=u,y=f=>{const M=f.target,{value:$}=M;L.value.country&&H({country_code:L.value.country,region_name:$}),v(f)}),u=b.length>0?((I=b.find(f=>f.value===u))==null?void 0:I.value)||"":u),l.code===F.PostCode&&(D=!a.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...l,error:S,frontendInput:m,handleSelect:C,isDisabled:N,isRequired:D,onBlur:g,onChange:y,onInvalid:c,options:b,value:u}})}let te;function H(e){var i;const t=ne.value.data,r=!!t,n=(i=t==null?void 0:t.shippingAddresses)==null?void 0:i[0],a=n==null?void 0:n.availableShippingMethods;r&&!a&&(clearTimeout(te),te=setTimeout(()=>{pe({criteria:e})},U))}const G=({addressType:e,code:t,index:r})=>r?`${e}-${t}-${r}`:`${e}-${t}`,T=e=>`checkout-address-form__${e}`,_e=({addressType:e,element:t})=>{const{code:r,value:n,defaultValue:a}=t;return s("input",{className:T(r),id:G({addressType:e,code:r}),name:r,type:"hidden",value:n||a},r)},xe=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:a,label:i,onBlur:o,onChange:d,onInvalid:g,validateRules:v,value:c}=t,h=ce(v);return s(Z,{disabled:a,error:n,children:s(ae,{"aria-label":i,autocomplete:X[r]||"off",className:T(r),floatingLabel:`${i} ${t.isRequired?"*":""}`,id:G({addressType:e,code:r}),onBlur:o,onChange:d,onInvalid:g,placeholder:i,required:t.isRequired||!1,type:"text",name:r,value:c??void 0,...h})})},ze=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:a,isRequired:i,label:o,multilineCount:d,onBlur:g,onChange:v,onInvalid:c,validateRules:h,value:E}=t,p=d??0,A=ce(h);return s(se,{children:Array.from(Array(p).keys()).map(l=>s(Z,{disabled:a,error:(n==null?void 0:n[l])||"",className:"dropin-field--multiline",children:s(ae,{id:G({addressType:e,code:r,index:l}),className:T(r),floatingLabel:`${o} ${l!=0?l:""} ${i&&l===0?"*":""}`,autocomplete:l===0?X[r]:"off","aria-label":o,placeholder:`${o} ${l!=0?l:""}`,type:"text",required:i&&l===0,onChange:v,onBlur:g,onInvalid:c,name:`${r}-${l}`,value:(E==null?void 0:E[l])||void 0,...A})},`${r}-${l}`))})},Pe=({addressType:e,element:t})=>{const{code:r,error:n,handleSelect:a,isDisabled:i,isRequired:o,label:d,onBlur:g,onInvalid:v,options:c,value:h}=t,E=a?{handleSelect:a}:{};return s(Z,{disabled:i,error:n,children:s(Ce,{id:G({addressType:e,code:r}),className:T(r),name:r,floatingLabel:`${d} ${o?"*":""}`,required:o,placeholder:d,"aria-label":d,options:c,value:h,autocomplete:X[r]||"off",onBlur:g,onInvalid:v,...E},r)})},Oe=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return _e({addressType:e,element:t});case"TEXT":return xe({addressType:e,element:t});case"MULTILINE":return ze({addressType:e,element:t});case"SELECT":return Pe({addressType:e,element:t});default:return null}},ce=e=>e?e.reduce((t,r)=>{switch(r.name){case w.DateRangeMax:return{...t,max:r.value};case w.DateRangeMin:return{...t,min:r.value};case w.FileExtensions:return{...t,accept:r.value};case w.InputValidation:return{...t,pattern:Be(r.value)};case w.MaxFileSize:case w.MaxImageHeight:case w.MaxImageWidth:return t;case w.MaxTextLength:return{...t,maxLength:r.value};case w.MinTextLength:return{...t,minLength:r.value};default:throw new Error(`Unknown rule: ${r.name}`)}},{}):{},x={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},Be=e=>{switch(e){case"alpha":return x.alpha.source;case"alphanumeric":return x.alphanumeric.source;case"alphanumeric-w-space":return x["alphanumeric-w-space"].source;case"alphanum-with-spaces":return x["alphanum-with-spaces"].source;case"url":return x.url.source;case"numeric":return x.numeric.source;case"email":return x.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},Ve=e=>B(Se,{...e,children:[s(k,{variant:"heading",size:"medium"}),s(k,{variant:"empty",size:"medium"}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large",fullWidth:!0}),s(k,{size:"large",fullWidth:!0,lines:3}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large"}),s(k,{size:"large"})]}),Ue=({addressType:e,className:t,fields:r,formRef:n,headingId:a,name:i,...o})=>B("div",{...o,className:V(["checkout-fields-form",t]),children:[s(le,{level:2,children:s(oe,{id:a}),className:"checkout-fields-form__title"}),s("form",{name:i,ref:n,className:V(["checkout-fields-form__form",t]),noValidate:!0,children:r.sort((d,g)=>!d.sortOrder||!g.sortOrder?d.code<g.code?-1:1:d.sortOrder-g.sortOrder).map(d=>Oe({element:d,addressType:e}))})]}),Ge=e=>{const t=new FormData(e),r=Object.fromEntries(t);return Object.entries(r).reduce((a,[i])=>{const o=e.elements[i];return o!=null&&o.validationMessage?{...a,[i]:o.validationMessage}:{...a}},{})};function Te(e){const[t,r]=j({});return W(()=>{e&&r(n=>({...n,country_id:e}))},[e]),{defaultValues:t}}function He({country:e,addressType:t}){const[r,n]=j([]);return W(()=>{if(!e){n([]);return}Fe(e,t).then(a=>{n(a||[])}).catch(a=>{console.error(a)})},[n,e,t]),{availableRegions:r}}function qe({autoFill:e,addressType:t,dismissError:r,loadAutoFill:n}){const[a,i]=j(!1),o=he.value.data,d=!!o,g=ne.value.data,v=!!g;W(()=>{var S;if(!e||!v||a)return;let c,h=!1;c=it({addressType:t,cart:g}),!c&&d&&(c=st({addressType:t,customer:o}),h=!0);const E=m=>m?m.split(ee).length>1:!1;if(!c)return;i(!0);const p={[F.City]:c.city,[F.Company]:c.company||"",[F.Country]:c.country.value,[F.FirstName]:c.firstName,[F.LastName]:c.lastName,[F.PostCode]:c.postCode||"",[F.Telephone]:c.telephone||"",[F.Vat]:c.vatId||""},A=c.region;if(A){const m=(S=A==null?void 0:A.id)==null?void 0:S.toString();m?(p[F.Region]=m,p[F.RegionId]=m):p[F.Region]=A.code}c!=null&&c.street&&c.street.length>0&&c.street.forEach((m,C)=>{p[`${F.Street}${Q}${C}`]=m}),((c==null?void 0:c.customAttributes)||[]).forEach(m=>{E(m.code)?m.value.split(ee).forEach((y,N)=>{p[`${m.code}${Q}${N}`]=y}):p[m.code]=m.value}),n({values:p,triggerAutoSave:h})},[t,e,g,o,a,v,d,n,r])}const $t=be(({addressType:e,autoFill:t=!0,children:r,headingId:n,name:a,preselectedFields:i,saveAddressHandler:o,...d},g)=>{const{fields:v}=Re(),c=ge.value.data,h=c===void 0,E=v===void 0,p=fe.value.data,A=p===void 0,{defaultValues:l}=Te(p==null?void 0:p.defaultCountry),S=at({fields:v,preselectedFields:i}),m=Me(null),{address:C,errors:y,loadAutoFill:N,onBlur:D,dismissError:b,onChange:u,onInvalid:I,onSelection:f,setAddress:M}=nt({formRef:m,type:e,defaultValues:l,preselection:S,saveAddressHandler:o}),{availableRegions:$}=He({country:C.country_id,addressType:e});if($e(g,()=>({triggerSaveAddress:de=>{if(!m.current)return;const me=Ge(m.current);if(ie(me))return o({signal:de,address:C})}})),qe({addressType:e,autoFill:t,loadAutoFill:N,dismissError:b}),E||h||A)return s(Ve,{"data-testid":`${e}-skeleton`});const ue=De({address:C,addressType:e,availableCountries:c,availableRegions:$,config:p,dismissError:b,errors:y,fields:v,onBlur:D,onChange:u,onInvalid:I,onSelection:f,setAddress:M}),K={[R.SHIPPING]:"shipping",[R.BILLING]:"billing"};return s(Ue,{...d,name:a,addressType:e,className:`checkout-${K[e]}-form`,"data-testid":`${K[e]}-form`,fields:ue,formRef:m,headingId:n})}),Ze="DROPIN__CHECKOUT",J=e=>`${Ze}__${e.toUpperCase()}`,je=(e,t)=>{window.localStorage.setItem(J(e),JSON.stringify(t))},We=e=>{const t=window.localStorage.getItem(J(e));return t?JSON.parse(t):null},Xe=e=>{window.localStorage.removeItem(J(e))};function Je(e){const[t,r]=q(null),n=O(i=>setTimeout(()=>{je(e,i)},U),[e]),a=O(()=>{Xe(e)},[e]);return z(()=>{const i=We(e);i&&r(i)},[e]),z(()=>{const i=re.on("checkout/order",()=>{a()});return()=>{i==null||i.off()}},[a]),{addressBackup:t,backupAddress:n,removeAddressBackup:a}}const Ke={[R.BILLING]:"billing",[R.SHIPPING]:"shipping"};function Ye({address:e,type:t}){z(()=>{const r=setTimeout(()=>{re.emit("checkout/address",{type:Ke[t],address:e})},U);return()=>{clearTimeout(r)}},[e,t])}const Qe={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},et=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],tt=e=>{const[t,r]=q({}),n=O(o=>{const{name:d,validity:g,validationMessage:v}=o;let c=g.valid?"":v;et.forEach(h=>{if(!g[h])return;const E=e[h];if(!E)return;const p=Qe[h];c=E.replace("{field}",o.getAttribute(p)||"")}),r(h=>({...h,[d]:c}))},[e]);return{errors:t,dismissError:o=>{t[o]&&r(d=>{const{[o]:g,...v}=d;return v})},validateFormElement:n,resetErrors:()=>{r({})}}},rt=e=>{const t=e.current;if(!t)return!1;const r=Ee(t);return ie(r)},nt=({formRef:e,type:t,defaultValues:r={},preselection:n={},saveAddressHandler:a})=>{const i=Ae({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),o=ve(!1),[d,g]=q({});Ye({address:d,type:t});const{addressBackup:v,backupAddress:c,removeAddressBackup:h}=Je(t),{errors:E,validateFormElement:p,dismissError:A,resetErrors:l}=tt(i),S=O(u=>{o.current=!1,a(u).then(()=>{h()}).catch(I=>{o.current=!0,console.error("Saving address form failed:",I)})},[h,a]),m=(u,I)=>{g(f=>({...f,[u]:I})),o.current=!0},C=({values:u,triggerAutoSave:I=!1})=>{l(),g(f=>({...f,...u})),I&&(o.current=!0)},y=u=>{const I=u.target,{name:f,value:M}=I;m(f,M),p(I)},N=u=>{const I=u.target;p(I)},D=u=>{const I=u.target,{name:f,value:M}=I;m(f,M),p(I)},b=u=>{u.target.checkValidity()};return z(()=>{g(u=>({...r,...n,...v,...u}))},[r,n,v]),z(()=>{if(!o.current)return;const u=c(d);return()=>{clearTimeout(u)}},[d,c]),z(()=>{if(!o.current||!rt(e))return;const u=new AbortController,I=u.signal,f=setTimeout(()=>{S({signal:I,address:d})},U);return()=>{clearTimeout(f),u.abort()}},[d,e,S]),{address:d,errors:E,loadAutoFill:C,dismissError:A,onChange:y,onSelection:D,onBlur:b,onInvalid:N,setAddress:g}},ot={countryCode:F.Country,region:F.Region,postCode:F.PostCode};function at({fields:e,preselectedFields:t}){return Ie(()=>!(!!e&&e.length>0)||!!!t?{}:Object.keys(t).reduce((a,i)=>{const o=ot[i];return!o||!e.some(g=>g.code===o)?a:{...a,[o]:t[i]}},{}),[e,t])}const st=({addressType:e,customer:t})=>e===R.BILLING?t.defaultBillingAddress:t.defaultShippingAddress,it=({addressType:e,cart:t})=>{if(e===R.BILLING)return t.billingAddress;const r=t.shippingAddresses;if(!(!r||r.length===0))return r[0]},ct=({billingAddress:e,billToShippingAddress:t,login:r,paymentMethods:n,placeOrder:a,shippingAddress:i,shippingMethods:o})=>B(se,{children:[s(_,{node:r}),i&&s(_,{node:i}),t&&s(_,{node:t}),o&&s(_,{node:o}),s(_,{node:n}),s(_,{node:e}),s(_,{node:a})]}),lt=({sections:e})=>B("div",{className:"checkout__content",children:[s(le,{level:1,className:"checkout-title",children:s(oe,{id:"Checkout.title"})}),e&&s(ct,{...e})]}),ut=({children:e,className:t,isLoading:r=!1,...n})=>B("div",{"data-testid":"checkout",className:V(["checkout",t]),...n,children:[r&&s(mt,{}),s(Le,{}),s(we,{}),e]});ut.Main=lt;const le=({className:e,children:t,level:r=2})=>{const n=r>=1&&r<=6?`h${r}`:"h2";return s(n,{className:e,children:t})},dt=()=>{const e=O(()=>{document.body.style.overflow="hidden"},[]),t=O(()=>{document.body.style.overflow=""},[]);return{lockScroll:e,unlockScroll:t}},mt=({className:e})=>{const{lockScroll:t,unlockScroll:r}=dt();return z(()=>(t(),r),[t,r]),s("div",{"data-testid":"checkout-overlay-loader",className:V(["checkout-overlay-loader",e]),children:s(ke,{})})};export{$t as A,ut as C,le as H,x as p};
